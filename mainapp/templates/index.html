{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Beyblade with Blinking AK Halo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: rgb(21, 0, 39);
    }
    canvas {
      display: block;
    }
  </style>
</head>
<body>
<script>
  let bg, babelade, cap, ak;
  let flash1, flash2, flash3, smoke1, smoke2, smoke3;
  let rev_smoke1, rev_smoke2, rev_smoke3;
  let spinAngle = 0;
  let orbitAngle = 0;
  let orbitRadius = 300;
  let orbitSpeed = 0.02;

  let direction = 1;
  let haloBlinking = false;
  let blinkAlpha = 0;
  let blinkDirection = 1;
  let barrelWorldX = 0;
  let barrelWorldY = 0;

  function preload() {
    bg = loadImage("{% static 'bg.png' %}");
    babelade = loadImage("{% static 'babelade.png' %}");
    cap = loadImage("{% static 'cap.png' %}");
    ak = loadImage("{% static 'ak.png' %}");
    flash1 = loadImage("{% static 'flash1.png' %}");
    flash2 = loadImage("{% static 'flash2.png' %}");
    flash3 = loadImage("{% static 'flash3.png' %}");
    smoke1 = loadImage("{% static 'smoke1.png' %}");
    smoke2 = loadImage("{% static 'smoke2.png' %}");
    smoke3 = loadImage("{% static 'smoke3.png' %}");
    rev_smoke1 = loadImage("{% static 'rev_smoke1.png' %}");
    rev_smoke2 = loadImage("{% static 'rev_smoke2.png' %}");
    rev_smoke3 = loadImage("{% static 'rev_smoke3.png' %}");
  }

  function setup() {
    createCanvas(windowWidth, windowHeight);
    imageMode(CENTER);
  }

  function draw() {
    clear();
    image(bg, (width + (width * 0.007)) / 2, height / 2, 1290, 1250);

    // WASD Controls
    if (keyIsDown(87)) orbitRadius = max(100, orbitRadius - 2);  // W
    if (keyIsDown(83)) orbitRadius = min(450, orbitRadius + 2);  // S
    if (keyIsDown(65)) direction = 1;                            // A
    if (keyIsDown(68)) direction = -1;                           // D

    orbitAngle += orbitSpeed * direction;

    let bladeX = width / 2 + cos(orbitAngle) * orbitRadius;
    let bladeY = height / 2 + sin(orbitAngle) * orbitRadius;

    // Spinning Beyblade
    push();
    translate(bladeX, bladeY);
    rotate(spinAngle);
    image(babelade, 0, 0, 150, 150);
    pop();

    // Cap
    push();
    translate(bladeX, bladeY);
    image(cap, 0, 0, 100, 100);
    pop();

    // AK angle and barrel tip with jitter
    let dx = mouseX - bladeX;
    let dy = mouseY - bladeY;
    let angleToMouse = atan2(dy, dx);
    if (haloBlinking) {
      degrees = 3
      let jitter = radians(random(-degrees, degrees));  // Â±15 degrees
      angleToMouse += jitter;
    }

    let barrelOffset = createVector(90, -12);
    barrelOffset.rotate(angleToMouse);
    barrelWorldX = bladeX + barrelOffset.x;
    barrelWorldY = bladeY + barrelOffset.y;

    // Position vibration
    let vibX = 0;
    let vibY = 0;
    if (haloBlinking) {
      let strength = 5;
      let offset = p5.Vector.fromAngle(angleToMouse);
      offset.setMag(random(-strength, strength));
      vibX = offset.x;
      vibY = offset.y;
    }

    // Draw AK with vibration and jitter
    push();
    translate(bladeX + vibX, bladeY + vibY);
    rotate(angleToMouse);
    image(ak, 20, 0, 150, 120);
    pop();

    // Flash and halo
    if (haloBlinking) {
      drawBlinkingHalo(barrelWorldX, barrelWorldY, 60, angleToMouse);
    }

    spinAngle += 0.18;
  }

function drawBlinkingHalo(x, y, size, angle) {
  // Animate alpha
  let rate = 10;
  blinkAlpha += blinkDirection * 15;
  if (blinkAlpha >= 255) {
    blinkAlpha = 255;
    blinkDirection = -rate;
  } else if (blinkAlpha <= 0) {
    blinkAlpha = 0;
    blinkDirection = rate;
  }

  // Add vibration to halo, smoke, and flash
  let vibX = 0;
  let vibY = 0;
  if (haloBlinking) {
    let strength = 5;
    let offset = p5.Vector.fromAngle(random(TWO_PI));
    offset.setMag(random(-strength, strength));
    vibX = offset.x;
    vibY = offset.y;
  }

  // Halo glow with vibration
  push();
  drawingContext.save();
  let gradient = drawingContext.createRadialGradient(x + vibX, y + vibY, 0, x + vibX, y + vibY, size);
  gradient.addColorStop(0, `rgba(255, 255, 120, ${blinkAlpha / 255})`);
  gradient.addColorStop(0.4, `rgba(255, 255, 0, ${blinkAlpha / 600})`);
  gradient.addColorStop(1, 'rgba(255, 255, 0, 0)');
  drawingContext.fillStyle = gradient;
  noStroke();
  ellipse(x + vibX, y + vibY, size * 2, size * 2);
  drawingContext.restore();
  pop();

  // Flash and smoke with vibration
  push();
  translate(x + vibX, y + vibY);
  rotate(angle);
  size += size * 0.2;

  let flash_lst = [], smoke_lst = [], rev_smoke_lst = [];

  for (let j = 0; j <= 10; j++) {
    flash_lst.push(flash1); smoke_lst.push(smoke1); rev_smoke_lst.push(rev_smoke1);
  }
  for (let j = 0; j <= 8; j++) {
    flash_lst.push(flash2); smoke_lst.push(smoke2);
  }
  for (let j = 0; j <= 20; j++) {
    flash_lst.push(flash3); smoke_lst.push(smoke3); rev_smoke_lst.push(rev_smoke2);
  }

  let flash = random(flash_lst);
  let smoke = random(smoke_lst);
  let rev_smoke = random(rev_smoke_lst);

  if (flash && smoke) {
    image(flash, 0, 0, size, size);
    tint(255, 80);
    image(smoke, 0, 0, size + size * 0.3, size + size * 0.3);
    noTint();
    tint(255, 60);
    image(rev_smoke, -100, -8, size * 0.6, size * 0.5);
    noTint();
  }

  pop();
}

  function mousePressed() {
    if (mouseButton === LEFT) {
      haloBlinking = true;
    }
  }

  function mouseReleased() {
    if (mouseButton === LEFT) {
      haloBlinking = false;
      blinkAlpha = 0;
    }
  }
</script>
</body>
</html>
